<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mercado Online</title>
    <link rel="icon" type="image/svg+xml" href="image/favicon.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
    <script src="js/env.js"></script>
    <script src="js/config.js"></script>
    <script src="js/script.js" defer></script>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <a href="index.html" class="logo"><i class="fas fa-shopping-basket"></i> Mercado Online</a>
        <nav class="navbar">
            <a href="maisvendidos" style="text-decoration: line-through;">Mais Vendidos</a>
            <a href="ofertas.html">Ofertas</a>
            <a href="produtos.html">Produtos</a>
            <a href="departamentos.html">Departamentos</a>
            <a href="contato" style="text-decoration: line-through;">Contato</a>
        </nav>
        <div class="icons">
            <div id="search-btn" class="fas fa-search"></div>
            <div id="cart-btn" class="fas fa-shopping-cart"></div>
            <div id="login-btn" class="fas fa-user"></div>
            <div id="menu-btn" class="fas fa-bars"></div>
        </div>
        <form class="search-form">
            <input type="text" id="search-box" placeholder="Buscar produtos...">
            <label for="search-box" class="fas fa-search"></label>
        </form>
        <div class="shopping-cart"></div>
        <form action="#" class="login-form">
            <h3 id="login-title">Olá, visitante</h3>
            <input type="email" placeholder="Email" required>
            <input type="password" placeholder="Senha" required>
            <a href="#">Esqueceu a senha?</a>
            <button type="submit" class="btn">Entrar</button>
            <button type="button" class="criar-btn" onclick="window.location.href='cadastro.html'">Criar uma Conta</button>
        </form>
    </header>

    <!-- Hero/banner -->
    <section class="inicio"></section>

  <!-- Categorias em Destaque -->
    <section class="categorias-destaque" id="categorias-destaque">
        <h1 class="cabecalho">Categorias em <span>Destaque</span></h1>
        <div class="swiper categorias-slider">
      <div class="swiper-wrapper" id="categorias-lista"></div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
        </div>
    </section>

    <!-- Produtos em Destaque -->
    <section class="produtos-destaque" id="produtos-destaque">
        <h1 class="cabecalho">Produtos em <span>Destaque</span></h1>
        <div id="loader-destaque" style="display:none; justify-content:center; align-items:center; margin:2rem 0;">
            <div class="spinner"></div>
        </div>
        <div class="swiper produto-slider">
            <div class="swiper-wrapper" id="destaque-lista"></div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
        </div>
    </section>

    <footer>
                    <!--FOOTER-->
    <section class="footer">
        <div class="box-container">

            <!-- QUEM SOMOS -->
            <div class="box">
                <div class="section-header">
                    <h3> Quem somos </h3>
                        <button class="toggle-btn">⬇</button>
                </div>
                            <div class="box-content">
                                <p> Seu Mercado Digital com ofertas e produtos sempre à mão!
                                Compre online e receba em casa com segurança e praticidade. </p>
                </div>
            </div>

            <!-- FORMAS DE PAGAMENTO -->
             <div class="box">
             <div class="section-header">
                <h3> Formas de Pagamento </h3>
                <button class="toggle-btn">⬇</button>
             </div>
                <div class="box-content">
                    <p> Aceitamos cartões de crédito, débito e vale alimentação. </p>
             </div>
            </div>

            <!-- LINKS RÁPIDOS -->
             <div class="box">
             <div class="section-header">
                <h3> Institucional </h3>
                <button class="toggle-btn">⬇</button>
                </div>
                <div class="box-content">
                    <a href="institucional.html" class="links"><i class="fa fa-arrow-right"></i> Sobre Nós </a>
                    <a href="institucional.html" class="links"><i class="fa fa-arrow-right"></i> Política de Privacidade </a>
                    <a href="institucional.html" class="links"><i class="fa fa-arrow-right"></i> Como Comprar </a>
                    <a href="institucional.html" class="links"><i class="fa fa-arrow-right"></i> Formas de Pagamento </a>
                    <a href="institucional.html" class="links"><i class="fa fa-arrow-right"></i> FAQ </a>
                    <a href="institucional.html" class="links"><i class="fa fa-arrow-right"></i> Fale Conosco </a>
                    <a href="institucional.html" class="links"><i class="fa fa-arrow-right"></i> Simulador de Frete </a>
                    <a href="institucional.html" class="links"><i class="fa fa-arrow-right"></i> Site Institucional </a>
             </div>
            </div>

            <!-- CONTATO COM O CLIENTE -->
             <div class="box">
                <div class="app">
                <h3> Relacionamento com o Cliente </h3>
                    <a href="#" class="links"><i class="fa fa-phone"></i> (00) 0000-0000 </a>
                    <a href="#" class="links"><i class="fab fa-whatsapp"></i> (00) 00000-0000 </a>
                    <a href="#" class="links"><i class="fa fa-envelope"></i> mercado@email.com </a>
                </div>
            </div>

            <!-- REDES SOCIAIS -->
             <div class="box">
             <div class="app">
                <h3> Baixe Nosso App </h3>
                    <div class="store-buttons">
                        <a href="#"><img src="image/google-play.png" alt="Google Play"></a>
                        <a href="#"><img src="image/app-store.png" alt="App Store"></a>
                </div>
             </div>
        
                <h3> Siga-Nos </h3>
                <div class="share">
                   <a href="#"><i class="fab fa-facebook-f"></i></a>
                    <a href="#"><i class="fab fa-youtube"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>

            <!-- TEXTO FINAL -->
             <div class="box">
                <div class="wide-text">        
                    <p>
                        <strong> Mercado Online LTDA </strong>
                        / CNPJ: 00.000.000./0001-00 / IE: 00000000-00
                        <br>
                        <strong>Mercado Online</strong>
                        é um website de vendas pelo qual você tem fácil acesso aos nossos produtos com facilidade, segurança e comodidade. Possui o conforto para agendar a entrega do seu pedido no local e horário que desejar, além de poder acompanhar o status do seu pedido em tempo real. Com um sistema e plataforma adequado para gerir sua compra, os seus dados permanecem em absoluta segurança.
                        <br><br>
                        Em caso de divergência entre os valores no site, o valor válido é o do carrinho de compras. Imagens ilustrativas. Compras sujeitas à confirmação de estoque. A fim de garantir o acesso de um maior número de clientes, as ofertas promocionais podem ter uma quantidade limitada por cliente. Os preços e condições de pagamento são válidos somente para compras via internet e podem ser alterados sem aviso prévio.
                        <br><br>
                        <strong>Proibida a venda de bebidas alcoólicas para menores de idade, conforme Lei n.º 8069/90, art. 81, inciso II do Estatuto da Criança e do Adolescente (ECA).</strong>
                    </p>
                </div>
             </div>
        </section>

        <div class="footer-bottom">
            <p>&copy; 2025 Control Power. Todos os direitos reservados.</p>
        </div>
    </footer>

    <!-- Script: carrega produtos em destaque e integra com carrinho -->
    <script>
    // Atualiza mini-carrinho ao abrir a página
    window.addEventListener('DOMContentLoaded', function(){
        if (typeof atualizarCarrinhoHeader === 'function') atualizarCarrinhoHeader();
        if (typeof updateCartBadge === 'function') updateCartBadge();
    });

    // Carregar categorias da API
      // Carregar categorias da API (imagem dinâmica: no momento usa SEM-IMAGEM)
    (function carregarCategorias(){
      const wrap = document.getElementById('categorias-lista');
      if (!wrap) return;
      fetch(apiUrl('/api/categorias'))
        .then(r => r.json())
        .then(data => {
          if (!data.success || !Array.isArray(data.categorias)) return;
          wrap.innerHTML = data.categorias.map(cat => {
            const nome = String(cat.nome || '').trim();
              const img = 'image/SEM-IMAGEM.png';
            return `
              <div class="swiper-slide box">
                <img src="${img}" alt="${nome}">
                <h3>${nome}</h3>
                  <a href="produtos.html?codgrp=${encodeURIComponent(cat.codgrp)}&categoria=${encodeURIComponent(nome)}" class="btn-categorias">Ver Categoria</a>
              </div>
            `;
          }).join('');
          if (typeof Swiper !== 'undefined') {
            setTimeout(function(){
              new Swiper('.categorias-slider', {
                loop: true,
                spaceBetween: 20,
                navigation: { nextEl: '.categorias-destaque .swiper-button-next', prevEl: '.categorias-destaque .swiper-button-prev' },
                autoplay: { delay: 7500, disableOnInteraction: false },
                breakpoints: { 0:{slidesPerView:2}, 768:{slidesPerView:3}, 1020:{slidesPerView:4}, 1240:{slidesPerView:5} }
              });
            }, 20);
          }
        })
        .catch(() => {});
    })();

    const loaderDestaque = document.getElementById('loader-destaque');
    if (loaderDestaque) loaderDestaque.style.display = 'flex';
    fetch(apiUrl('/api/produtos?offset=0&limit=20'))
      .then(res => res.json())
      .then(data => {
        const lista = document.getElementById('destaque-lista');
        if (loaderDestaque) loaderDestaque.style.display = 'none';
        if (data.success && data.produtos.length > 0) {
          const toNumber = (n) => {
            if (n === null || n === undefined) return NaN;
            if (typeof n === 'number') return n;
            const s = String(n).replace(',', '.');
            const v = Number(s);
            return isNaN(v) ? NaN : v;
          };
          const toDateOnly = (s) => {
            if (!s) return null;
            if (/^\d{4}-\d{2}-\d{2}$/.test(s)) { const [Y,M,D] = s.split('-').map(Number); return new Date(Y, M-1, D); }
            const m = String(s).match(/^(\d{2})[.\/-](\d{2})[.\/-](\d{4})$/);
            if (m) return new Date(Number(m[3]), Number(m[2])-1, Number(m[1]));
            const d = new Date(s); return isNaN(d) ? null : new Date(d.getFullYear(), d.getMonth(), d.getDate());
          };
          const now = new Date();
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          const cardsHTML = data.produtos.map(prod => {
            const fimDate = toDateOnly(prod.fimpromo);
            const precoBase = toNumber(prod.preco);
            const precoPromo = toNumber(prod.precoPromo);
            const isPromoActive = !!(fimDate && fimDate.getTime() > today.getTime() && !isNaN(precoPromo) && precoPromo > 0 && precoPromo < precoBase);
            const descontoPerc = isPromoActive && precoBase > 0 ? Math.max(1, Math.min(99, Math.round((1 - (precoPromo / precoBase)) * 100))) : 0;
            const precoBaseFmt = precoBase.toFixed(2);
            const precoPromoFmt = precoPromo.toFixed(2);
            return `
            <div class="swiper-slide box" data-procod="${prod.procod}" style="background:#fff;box-shadow:0 .1rem 1rem rgb(124,124,124);border-radius:.5rem;text-align:center;display:block;height:25rem;width:20rem;position:relative;">
              ${isPromoActive ? `<div class='badge-desconto'>-${descontoPerc}%</div>` : ''}
              ${prod.imagemTipo && prod.imagem ? `<img src="data:image/${prod.imagemTipo};base64,${prod.imagem}" alt="${prod.nome}" style="height:50%;width:80%;object-fit:contain;margin-top:1rem;">` : `<img src="image/SEM-IMAGEM.png" alt="Sem imagem" style="height:50%;width:80%;object-fit:contain;margin-top:1rem;">`}
              <h1 style="font-size:1.5rem;color:rgb(22,87,207);">${prod.nome}</h1>
              <div class="qty-selector" style="margin:0.5rem 0;display:flex;justify-content:center;align-items:center;gap:0.5rem;">
                <button class="qty-minus" type="button">-</button>
                <input type="number" class="qty-input" min="1" value="1" style="width:40px;text-align:center;font-size:1.2rem;">
                <button class="qty-plus" type="button">+</button>
              </div>
              <div class="box-footer">
                <div style="display:flex;flex-direction:column;align-items:flex-start;">
                  ${isPromoActive ? `<div class='price-old'>R$ ${precoBaseFmt}</div>` : ''}
                  <div style="display:flex;align-items:baseline;">
                    <span class="price">R$ ${isPromoActive ? precoPromoFmt : precoBaseFmt}</span>
                    <span class="und">/${prod.und}</span>
                  </div>
                </div>
                <button class="add-carrinho-btn"><i class="fas fa-shopping-cart"></i></button>
              </div>
            </div>`;
          });
          lista.innerHTML = cardsHTML.join('');

          // (logs de depuração removidos)

          // Inicializa o Swiper após renderizar os cards
          if (typeof Swiper !== 'undefined') {
            setTimeout(function(){
              new Swiper('.produto-slider', {
                loop: true,
                spaceBetween: 20,
                navigation: { nextEl: '.produtos-destaque .swiper-button-next', prevEl: '.produtos-destaque .swiper-button-prev' },
                autoplay: { delay: 7500, disableOnInteraction: false },
                breakpoints: { 0:{slidesPerView:2}, 768:{slidesPerView:3}, 1020:{slidesPerView:4}, 1240:{slidesPerView:5} }
              });
            }, 50);
          }

          // Eventos de quantidade e adicionar ao carrinho
          lista.querySelectorAll('.box').forEach(box => {
            const minus = box.querySelector('.qty-minus');
            const plus = box.querySelector('.qty-plus');
            const input = box.querySelector('.qty-input');
            minus.onclick = () => { let v = parseInt(input.value)||1; if (v>1) input.value = v-1; };
            plus.onclick  = () => { let v = parseInt(input.value)||1; input.value = v+1; };
            input.oninput  = () => { if (input.value < 1) input.value = 1; };
            box.querySelector('.add-carrinho-btn').onclick = () => {
              const procod = box.getAttribute('data-procod');
              const prod = data.produtos.find(p => String(p.procod) === String(procod));
              const qtd = parseInt(input.value) || 1;
              const now = new Date();
              const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
              const fimDate = toDateOnly(prod.fimpromo);
              const precoBase = toNumber(prod.preco);
              const precoPromo = toNumber(prod.precoPromo);
              const isPromoActive = !!(fimDate && fimDate.getTime() > today.getTime() && !isNaN(precoPromo) && precoPromo > 0 && precoPromo < precoBase);
              const prodCarrinho = { ...prod, preco: isPromoActive ? precoPromo : precoBase };
              adicionarAoCarrinho(prodCarrinho, qtd);
              // Feedback rápido
              let msg = document.createElement('div');
              msg.textContent = 'ADICIONADO COM SUCESSO';
              msg.style = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#1657cf;color:#fff;padding:1rem 2rem;border-radius:2rem;font-size:1.4rem;font-weight:bold;z-index:9999;transition:opacity .5s';
              document.body.appendChild(msg);
              setTimeout(()=>{ msg.style.opacity='0'; setTimeout(()=>msg.remove(),500); },1000);
            };
          });
        } else {
          lista.innerHTML = '<div>Nenhum produto encontrado.</div>';
        }
      })
      .catch(() => {
        document.getElementById('destaque-lista').innerHTML = '<div>Erro ao buscar produtos.</div>';
      });

    function adicionarAoCarrinho(produto, qtd = 1) {
      let carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
      const idx = carrinho.findIndex(item => String(item.procod) === String(produto.procod));
      if (idx > -1) {
        // Atualiza preço/und para refletir promoção atual
        carrinho[idx].preco = produto.preco;
        carrinho[idx].und = produto.und || carrinho[idx].und;
        carrinho[idx].qtd += qtd;
      } else { carrinho.push({ ...produto, qtd }); }
      localStorage.setItem('carrinho', JSON.stringify(carrinho));
      if (typeof updateCartBadge === 'function') updateCartBadge();
      window.dispatchEvent(new Event('storage'));
    }
    </script>
</body>

</html>