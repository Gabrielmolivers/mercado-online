<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - Mercado Online</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="icon" type="image/svg+xml" href="image/favicon.svg" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style>
    .checkout-container { max-width: 900px; margin: 2rem auto; padding: 1rem; }
    .resumo { background: #fff; border-radius: .5rem; box-shadow: 0 .1rem 1rem rgba(0,0,0,.15); padding: 1rem; }
    .resumo h2 { margin-top: 0; }
    .resumo .linha { display: flex; justify-content: space-between; padding: .5rem 0; border-bottom: 1px solid #eee; }
    .resumo .linha:last-child { border-bottom: 0; }
    .total { font-weight: bold; font-size: 1.2rem; color: var(--blue); }
    .acoes { display: flex; gap: 1rem; margin-top: 1rem; }
  .entrega-card { margin-top: 1rem; background:#f9fbff; border:1px solid #e3eefc; border-radius:.5rem; padding:1rem; display:none; }
    .entrega-card h3 { margin:0 0 .5rem 0; color: var(--blue); font-size:1.6rem; }
    .grid-3 { display:grid; grid-template-columns: 2fr 2fr 1fr; gap: .8rem; }
    .grid-2 { display:grid; grid-template-columns: 2fr 1fr; gap: .8rem; margin-top:.8rem; }
    .entrega-card label { font-size:1.2rem; font-weight:600; color:#333; }
    .entrega-card input { width:100%; padding:.6rem .8rem; border:1px solid #ccc; border-radius:.4rem; font-size:1.2rem; background:#fff; }
  .entrega-card input.invalid { border-color:#d32f2f; box-shadow:0 0 0 3px rgba(211,47,47,0.15); }
    /* Selects com estilo de botão azul */
    #entrega-select, #pagto-select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background: var(--blue);
      color: #fff;
      font-weight: bold;
      font-size: 1.4rem;
      padding: .8rem 2.6rem .8rem 1rem;
      border: none;
      border-radius: .5rem;
      cursor: pointer;
      box-shadow: 0 .1rem .6rem rgba(0,0,0,.15);
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='white'><path d='M7 10l5 5 5-5z'/></svg>");
      background-repeat: no-repeat;
      background-position: right .8rem center;
      background-size: 14px;
    }
    #entrega-select:hover, #pagto-select:hover { background:#130f40; }
    #entrega-select:focus, #pagto-select:focus { outline: 3px solid rgba(22,87,207,.25); }
    @media (max-width: 600px){
      #entrega-select, #pagto-select { width: 100%; }
    }
    @media (max-width: 600px){
      .grid-3 { grid-template-columns: 1fr; }
      .grid-2 { grid-template-columns: 1fr; }
      .resumo .linha { flex-direction: column; align-items: flex-start; gap:.5rem; }
    }
    /* Destaque visual para frete grátis */
    #linha-frete #valor-frete.frete-gratis { color:#2e7d32; font-weight:700; }
    /* Troco (dinheiro) */
  .troco-card { margin-top: .6rem; background:#fffaf0; border:1px solid #ffe0a3; border-radius:.5rem; padding: .8rem; display:none; }
    .troco-card label { font-size:1.2rem; font-weight:600; color:#6b4b00; }
  .troco-card input { width: 220px; max-width:100%; padding:.6rem .8rem; border:1px solid #d8b565; border-radius:.4rem; font-size:1.2rem; }
  .troco-card input.invalid { border-color:#d32f2f; box-shadow:0 0 0 3px rgba(211,47,47,0.15); }
  </style>
</head>
<body>
  <header class="header"></header>

  <main class="checkout-container">
    <h1>Checkout</h1>
    <div id="aviso"></div>
    <section class="resumo">
      <h2>Resumo do Pedido</h2>
  <div id="itens"></div>
  <div id="linha-frete" class="linha" style="display:none;"><span>Entrega</span><span id="valor-frete">R$ 0,00</span></div>
  <div class="linha total"><span>Total</span><span id="total">R$ 0,00</span></div>
      <div class="linha" style="border-bottom:0; display:flex; gap:1rem; align-items:center;">
        <label for="entrega-select" style="font-weight:bold;">Forma de entrega:</label>
        <select id="entrega-select">
          <option value="1" selected>Retirar na loja</option>
          <option value="2">Entregar</option>
        </select>
      </div>
      <div id="msg-frete" style="display:none; color:#8a6d3b; background:#fcf8e3; border:1px solid #faebcc; padding:.6rem .8rem; border-radius:.4rem; margin:-.6rem 0 .6rem; font-size:1.2rem;">
        Para pedidos abaixo de R$ 50,00 será cobrada taxa de entrega de R$ 5,00.
      </div>
      <div id="endereco-entrega" class="entrega-card">
        <h3>Endereço da entrega</h3>
        <div class="grid-3">
          <div>
            <label for="entrega-endereco">Endereço</label>
            <input id="entrega-endereco" type="text" placeholder="Rua, Av..." />
          </div>
          <div>
            <label for="entrega-bairro">Bairro</label>
            <input id="entrega-bairro" type="text" placeholder="Bairro" />
          </div>
          <div>
            <label for="entrega-numero">Número</label>
            <input id="entrega-numero" type="text" placeholder="Nº" />
          </div>
        </div>
        <div class="grid-2">
          <div>
            <label for="entrega-complemento">Complemento (opcional)</label>
            <input id="entrega-complemento" type="text" placeholder="Apto, bloco, referência" />
          </div>
        </div>
      </div>
      <div class="linha" style="border-bottom:0; display:flex; gap:1rem; align-items:center;">
        <label for="pagto-select" style="font-weight:bold;">Forma de pagamento:</label>
        <select id="pagto-select">
          <option value="D">Dinheiro</option>
          <option value="C">Cartão</option>
          <option value="P">PIX</option>
        </select>
      </div>
      <div id="troco-dinheiro" class="troco-card">
        <label for="troco-valor">TROCO PARA:</label>
        <input id="troco-valor" type="text" inputmode="decimal" placeholder="R$ 0,00" />
      </div>
      <div class="linha" style="flex-direction: column; align-items: stretch; gap:.5rem; border-bottom:0;">
        <label for="obs-pedido" style="font-weight:bold;">Observações do pedido</label>
        <textarea id="obs-pedido" rows="3" style="width:100%; padding:.6rem .8rem; border:1px solid #ccc; border-radius:.4rem; font-size:1.2rem; resize: vertical;" placeholder="Ex.: entregar após as 18h, interfone com o porteiro, troco para R$ 50,00..."></textarea>
      </div>
      <div class="acoes">
        <a class="btn" href="carrinho.html">Voltar ao Carrinho</a>
        <button class="btn" id="confirmar">Confirmar Pedido</button>
      </div>
    </section>
  </main>

  <footer></footer>

  <script src="js/env.js"></script>
  <script src="js/config.js"></script>
  <script src="js/layout.js" defer></script>
  <script src="js/script.js" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Atualiza footer com parâmetros
      fetch(apiUrl('/api/parametros'))
        .then(r=>r.json())
        .then(data => {
          if (data.success && data.parametros) {
            window.__PARAMS__ = data.parametros;
            const f = document.getElementById('footer-dynamic');
            if (f) {
              const ano = new Date().getFullYear();
              const nome = data.parametros.razao || 'Mercado Online';
              f.textContent = `© ${ano} ${nome}. Todos os direitos reservados.`;
            }
          }
        })
        .catch(()=>{});
      // Exigir login
      const usuario = JSON.parse(localStorage.getItem('usuarioLogado') || 'null');
      if (!usuario || !usuario.id) {
        alert('Você precisa estar logado para continuar.');
        window.location.href = 'cadastro.html';
        return;
      }

      // Carregar carrinho
      const carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');
      const itensEl = document.getElementById('itens');
      const totalEl = document.getElementById('total');
      if (!carrinho.length) {
        itensEl.innerHTML = '<p>Seu carrinho está vazio.</p>';
        return;
      }
  let total = 0; // subtotal dos itens
  let entregaTaxaAtual = 0; // taxa de entrega dinâmica (0 ou 5)
      itensEl.innerHTML = '';
      carrinho.forEach(item => {
        const preco = typeof item.preco === 'string' ? parseFloat(item.preco.replace(',', '.')) : Number(item.preco);
        const qtd = item.qtd || 1;
        const sub = preco * qtd;
        total += sub;
        const div = document.createElement('div');
        div.className = 'linha';
        div.innerHTML = `<span>${item.nome} x${qtd}</span><span>R$ ${sub.toFixed(2)}</span>`;
        itensEl.appendChild(div);
      });
      // Inicializa totais (subtotal + possível frete)
      // Parâmetros dinâmicos (cache local)
      let PARAMS = { vlr_pedminimo: 50, vlr_entrega: 5 };
      function carregarParametros(){
        fetch(apiUrl('/api/parametros'))
          .then(r => r.json())
          .then(data => {
            if (data.success && data.parametros) {
              PARAMS.vlr_pedminimo = Number(data.parametros.vlr_pedminimo) || PARAMS.vlr_pedminimo;
              PARAMS.vlr_entrega = Number(data.parametros.vlr_entrega) || PARAMS.vlr_entrega;
              // Atualiza texto da mensagem de frete
              const msg = document.getElementById('msg-frete');
              if (msg) {
                msg.innerHTML = `Para pedidos abaixo de R$ ${PARAMS.vlr_pedminimo.toFixed(2)} será cobrada taxa de entrega de R$ ${PARAMS.vlr_entrega.toFixed(2)}.`;
              }
              aplicarFreteUI();
            }
          })
          .catch(()=>{});
      }
      carregarParametros();
      function aplicarFreteUI(){
        const freteMin = PARAMS.vlr_pedminimo;
        const freteValor = PARAMS.vlr_entrega;
        const entregar = entregaSelect.value === '2';
        const precisaFrete = entregar && total < freteMin;
        entregaTaxaAtual = precisaFrete ? freteValor : 0;
        // mensagem
        const msg = document.getElementById('msg-frete');
        msg.style.display = precisaFrete ? 'block' : 'none';
        // linha frete e total
        const linhaFrete = document.getElementById('linha-frete');
        const valorFreteEl = document.getElementById('valor-frete');
        if (entregar) {
          linhaFrete.style.display = 'flex';
          valorFreteEl.textContent = entregaTaxaAtual === 0 ? 'Grátis' : `R$ ${entregaTaxaAtual.toFixed(2)}`;
          valorFreteEl.classList.toggle('frete-gratis', entregaTaxaAtual === 0);
        } else {
          linhaFrete.style.display = 'none';
        }
        totalEl.textContent = `R$ ${(total + entregaTaxaAtual).toFixed(2)}`;
      }
      totalEl.textContent = `R$ ${(total + entregaTaxaAtual).toFixed(2)}`;

      // Buscar dados do cliente para pré-preencher endereço de entrega
      let clienteBase = null;
      fetch(apiUrl(`/api/cliente/${usuario.id}`))
        .then(r => r.json())
        .then(cli => {
          if (cli.success && cli.cliente) {
            clienteBase = cli.cliente;
          }
        })
        .catch(()=>{});

      // Mostrar/ocultar endereço de entrega com base na seleção
      const entregaSelect = document.getElementById('entrega-select');
      const boxEntrega = document.getElementById('endereco-entrega');
      function aplicarEntregaUI(){
        if (entregaSelect.value === '2') { // Entregar
          boxEntrega.style.display = 'block';
          // Pré-preenche com endereço do cadastro
          const end = document.getElementById('entrega-endereco');
          const bairro = document.getElementById('entrega-bairro');
          const numero = document.getElementById('entrega-numero');
          if (clienteBase) {
            end.value = clienteBase.ENDERECO || clienteBase.endereco || end.value || '';
            bairro.value = clienteBase.BAIRRO || clienteBase.bairro || bairro.value || '';
            numero.value = clienteBase.NUMERO || clienteBase.numero || numero.value || '';
          }
        } else {
          boxEntrega.style.display = 'none';
          // limpa marcações de erro quando não for entrega
          document.getElementById('entrega-endereco')?.classList.remove('invalid');
          document.getElementById('entrega-bairro')?.classList.remove('invalid');
          document.getElementById('entrega-numero')?.classList.remove('invalid');
        }
        aplicarFreteUI();
      }
      entregaSelect.addEventListener('change', aplicarEntregaUI);
  aplicarEntregaUI();

      // Mostrar/ocultar campo TROCO PARA conforme pagamento
      const pagtoSelect = document.getElementById('pagto-select');
      const trocoBox = document.getElementById('troco-dinheiro');
      const trocoInput = document.getElementById('troco-valor');
      function aplicarTrocoUI(){
        trocoBox.style.display = (pagtoSelect.value === 'D') ? 'block' : 'none';
      }
      pagtoSelect.addEventListener('change', aplicarTrocoUI);
      aplicarTrocoUI();

      // Máscara simples de moeda BR para o campo troco
      function formatBRL(val){
        const onlyDigits = String(val).replace(/\D+/g,'');
        const cents = onlyDigits === '' ? '0' : onlyDigits;
        const num = (parseInt(cents,10) || 0) / 100;
        return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      }
      function parseBRLToNumber(str){
        if (!str) return 0;
        const s = String(str).replace(/[^0-9,\.]/g,'').replace(/\./g,'').replace(',', '.');
        const n = parseFloat(s);
        return isNaN(n) ? 0 : n;
      }
      function attachMoneyMask(el){
        if (!el) return;
        el.addEventListener('input', () => {
          const caretToEnd = document.activeElement === el; // simples
          el.value = formatBRL(el.value);
          if (caretToEnd) el.setSelectionRange(el.value.length, el.value.length);
        });
        // inicia vazio formatado se já existir valor
        if (el.value) el.value = formatBRL(el.value);
      }
      attachMoneyMask(trocoInput);

      // Remove destaque de erro ao digitar
      ['entrega-endereco','entrega-bairro','entrega-numero'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', () => el.classList.remove('invalid'));
      });

      // Confirmar pedido => buscar dados do cliente e enviar para API
  document.getElementById('confirmar').addEventListener('click', () => {
        const itens = JSON.parse(localStorage.getItem('carrinho') || '[]');
        if (!itens.length) {
          alert('Seu carrinho está vazio.');
          return;
        }
  const sel = document.getElementById('pagto-select');
  const meioPagto = sel ? sel.value : 'D'; // D=Dinheiro, C=Cartão, P=PIX
  // Recalcula taxa de entrega no momento do envio
  const taxaEntrega = (document.getElementById('entrega-select')?.value === '2' && total < PARAMS.vlr_pedminimo) ? PARAMS.vlr_entrega : 0;
  const totalPagar = total + taxaEntrega;
        // Se pagamento for DINHEIRO, exigir TROCO PARA preenchido (> 0)
        if (meioPagto === 'D') {
          const tEl = document.getElementById('troco-valor');
          const raw = (tEl?.value || '').trim();
          const valNum = parseBRLToNumber(raw);
          tEl?.classList.remove('invalid');
          // Troco é obrigatório e deve ser MAIOR que o total da compra
          if (!raw || valNum <= totalPagar) {
            document.getElementById('troco-dinheiro').style.display = 'block';
            tEl?.classList.add('invalid');
            alert(`Informe o valor do TROCO PARA maior que o total da compra (Total: R$ ${totalPagar.toFixed(2)}).`);
            tEl?.focus();
            document.getElementById('troco-dinheiro')?.scrollIntoView({ behavior:'smooth', block:'center' });
            return;
          }
        }
        const tipoEntrega = (document.getElementById('entrega-select')?.value) || '1';
        // Se for entrega, exigir endereço/bairro/número preenchidos
        if (tipoEntrega === '2') {
          const endEl = document.getElementById('entrega-endereco');
          const baiEl = document.getElementById('entrega-bairro');
          const numEl = document.getElementById('entrega-numero');
          const end = (endEl?.value || '').trim();
          const bai = (baiEl?.value || '').trim();
          const num = (numEl?.value || '').trim();
          // limpa estados anteriores
          endEl?.classList.remove('invalid');
          baiEl?.classList.remove('invalid');
          numEl?.classList.remove('invalid');
          let faltando = [];
          if (!end) { faltando.push('Endereço'); endEl?.classList.add('invalid'); }
          if (!bai) { faltando.push('Bairro'); baiEl?.classList.add('invalid'); }
          if (!num) { faltando.push('Número'); numEl?.classList.add('invalid'); }
          if (faltando.length) {
            alert('Para entrega em domicílio, preencha: ' + faltando.join(', ') + '.');
            // Foca no primeiro campo faltante
            const first = faltando[0];
            if (first === 'Endereço') endEl?.focus();
            else if (first === 'Bairro') baiEl?.focus();
            else if (first === 'Número') numEl?.focus();
            boxEntrega?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            return;
          }
        }
        fetch(apiUrl(`/api/cliente/${usuario.id}`))
          .then(r => r.json())
          .then(cli => {
            if (!cli.success || !cli.cliente) {
              alert('Não foi possível obter os dados do cliente.');
              return;
            }
            // Observação base digitada
            let obsBase = (document.getElementById('obs-pedido')?.value || '').trim();
            // Se pagamento em dinheiro e campo de troco preenchido, acrescenta na observação
            if (meioPagto === 'D') {
              const valTroco = (document.getElementById('troco-valor')?.value || '').trim();
              if (valTroco) {
                // Normaliza para garantir prefixo R$
                const trocoFmt = valTroco.startsWith('R$') ? valTroco : `R$ ${valTroco}`;
                const linhaTroco = `TROCO PARA: ${trocoFmt}`;
                obsBase = obsBase ? `${obsBase}\n${linhaTroco}` : linhaTroco;
              }
            }
            // Observação de frete (informativo)
            if (taxaEntrega > 0) {
              const linhaFrete = `ENTREGA: R$ ${taxaEntrega.toFixed(2)} (pedido abaixo de R$ ${PARAMS.vlr_pedminimo.toFixed(2)})`;
              obsBase = obsBase ? `${obsBase}\n${linhaFrete}` : linhaFrete;
            } else if (document.getElementById('entrega-select')?.value === '2') {
              const linhaFrete = `ENTREGA: Grátis`;
              obsBase = obsBase ? `${obsBase}\n${linhaFrete}` : linhaFrete;
            }

            const cliente = {
              id: usuario.id,
              nome: usuario.nome,
              endereco: (tipoEntrega === '2') ? (document.getElementById('entrega-endereco').value || '') : '',
              bairro: (tipoEntrega === '2') ? (document.getElementById('entrega-bairro').value || '') : '',
              numero: (tipoEntrega === '2') ? (document.getElementById('entrega-numero').value || '') : '',
              meio_pagto: meioPagto,
              tipo_entrega: parseInt(tipoEntrega, 10),
              obs: obsBase.slice(0, 500)
            };
            fetch(apiUrl('/api/finalizar-compra'), {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ itens, cliente })
            })
            .then(r => r.json())
            .then(data => {
              if (data.success) {
                alert('Pedido confirmado com sucesso!');
                // Limpa apenas o carrinho, preservando sessão do usuário
                localStorage.removeItem('carrinho');
                // Dispara evento para atualizar badge/header antes do redirect
                window.dispatchEvent(new Event('storage'));
                window.location.href = 'index.html';
              } else {
                alert('Erro ao confirmar pedido: ' + (data.error || 'Tente novamente.'));
              }
            })
            .catch(() => alert('Erro ao conectar ao servidor.'));
          })
          .catch(() => alert('Erro ao buscar dados do cliente.'));
      });
    });
  </script>
</body>
</html>
